package com.uiptv.util;

import com.uiptv.model.Account;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import static org.junit.jupiter.api.Assertions.*;

class StalkerPortalParserTest {

    @Test
    void testParseAndSave() throws IOException {
        Path path = Paths.get("src/test/resources/stalker_codes.txt");
        String text = new String(Files.readAllBytes(path));

        List<Account> savedAccounts = new ArrayList<>();
        StalkerPortalParser parser = new StalkerPortalParser(
                name -> null, // Mock: always return null (no existing account)
                savedAccounts::add // Mock: add to list instead of saving to DB
        );

        parser.parseAndSave(text, false, false, false);

        // DEBUG: print parsed results to help track why count differs
        System.out.println("DEBUG: savedAccounts.size=" + savedAccounts.size());
        savedAccounts.forEach(a -> System.out.println("DEBUG: MAC=" + a.getMacAddress() + " URL=" + a.getUrl() + " SERIAL=" + a.getSerialNumber()));

        // Assertions
        assertNotNull(savedAccounts);

        String[][] expected = {
                {"http://mock.one:80/c/", "00:1A:79:05:45:52", "BE601B6579209", "DC42B0D82A09EEC10D06B9794D1632D4980FA82BACD928D07729F124940FC51A", "1CA24ECB1AAD7D2D7D8DFD50EFCF14235BB2DAF4CB88E2729EAB790357C3F92B", "B57A644020D5B8AE9A3C77C347C7128885F92AE009E580339DB65120D6D600F3"},
                {"http://mock.one:80/c/", "00:1A:79:06:23:62", "3C1AA2711FF45", "9BEE76CABC8003E85AEDACCEE7FA35E7FFA2795E3603E1AF6351BB1184E2F330", "DBC96C50B2DD25F13B19CDDED89577F92159C6C5075DEFF4B830F2414C4CC6BC", "4E978A3E585D9B72066E67E91D46A3CE531F99719125C69DA5ECBE6C26C86C50"},
                {"http://mock.two:8080/c/", "00:1A:79:3B:2F:91", "78D24AA25373A", "42980C5B0D2C22910076E29D86F32E0655F242809D13374788E2509E61619613", "CD85AEC5AD4E72F39CDF354F59CA1BBE97E78AC5126B588B3BEACDCE7144FDF0", "E9B86B5E4D24847638898E41219B22A68F3F81FE19EAA1FE6CA0C33B66D0DE3B"},
                {"http://mock.two:8080/c/", "00:1A:79:39:9D:90", "3AD508969A385", "C5096E35584006D5BBF30D0FA9270AB10C2E7499F986892CC5008AEF3FA03614", "83B1FB2AD667B1F18F50A455DF84D4D32A59436B9FB8493450840B6DA33457CA", "406BBF9DE4198E09DE70D53F6B719BA9558FDDEB42DDF1103B3F2B48B08ED359"},
                {"http://mock.three:80/c/", "00:1A:79:5D:3D:CD", null, null, null, null},
                {"http://mock.four:80/c/", "00:1A:79:3B:7F:91", null, null, null, null},
                {"http://mock.five:80/c/", "00:1A:79:24:36:8A", null, null, null, null},
                {"http://mock.six:80/c/", "00:1A:79:F5:00:5C", null, null, null, null},
                {"http://mock.seven:80/c/", "00:1A:79:0E:1D:79", null, null, null, null},
                {"http://mock.seven:80/c/", "00:1A:79:EC:9D:93", null, null, null, null},
                {"http://mock.five:80/c/", "00:1A:79:A2:BC:EA", null, null, null, null},
                {"http://mock.eight/c/", "00:1A:79:BB:D1:84", "DC817BA87A232", "E5EACC6156E70C13FD9E45F24BDC77299A2950FC26F2A85C5C5F4C767E14A519", "0891240D302D6CCB92BD8543FE330C3EFBB81479A308393FCB77BFF0DF13BD00", "C98332610E4D26DDFB6FB02958BF2522193DAB48307F7563BCA15433C05E7D0F"},
                {"http://mock.eight/c/", "00:1A:79:CF:46:45", "83C9D439BBF5E", "F53A7584FA2D08F3F89C3B2AF21E903BD9A593768BA0E0DAC201C1C07FE2DD27", "6258553724971DD3A7516E65DD899B8785D35034B8BB1F88272EAE997F1B115F", "89A41E301B340651CFC272A7B1D0B7F1ABAA6558AC8D0E5560B590BEC40A5A93"},
                {"http://mock.ten:8080/c/", "00:1A:79:59:47:5A", "6DD87A604DFB4", "E69656C310999BCC2E97A9E871B6CF159FD1680B278015F291759FB71D5F399D", "04E4CBC3274B575C6765E3E852A72044CF22C5945EC25F870B9550BB1763C239", "80014AD161DABEA8DF2DA95FF5DDDB13F49E18749E104D33CB6ABD01B1375864"},
                {"http://mock.ten:8080/c/", "00:1A:79:08:48:45", "96A4E7FA35E3B", "E669DDE82ECF980E167FE520A73CB28620300904144C44783D5B9E163E785D1B", "4977A8C32A9EEFC2D2D78484D6526D519B527E1917210759835F86D4DE2B9562", "B86C69A0983EC70EA6D22E3883EFE5A9B97F4D307C03F3F8731DB5730F4FED69"},
                {"http://mock.eleven:80/c/", "00:1A:79:00:16:2f", "5CE59AA334B70", "2A8B34D7459666E5F41E4DD0DF6AFCCE4A166448D868EC28DD75B5741E8A72FD", "5A22C286FA7AF5640F453BC147C80AA6DED44A2C87EF1935D00187CDF29E3208", "6FDF82EB43B7CB17F76F6D252E0936E1B012BDFC98EC6E93BE38EADBF0FC9D87"},
                {"http://mock.eleven:80/c/", "00:1A:79:c9:de:ad", "4BE615442A14B", "ACD84554B796C5007CF15AED2266F6D65EEC4CA2C25FF17C057E4FB2FACC232F", "3C3EEA98F5BF9363B760B48BE98A97A09E2397489935566634B9866832309CE7", "EE296F6EDBACD4D813DFF4268C1217668B8FC69EE99FD925B72B734AED489DE9"},
                {"http://mock.eleven:80/c/", "00:1A:79:9c:9d:25", "8DEB31FD8AFA9", "1F99C35451487772AA0D21CBFFA208770DCBCA97049CB6DCDCB76D830B9E4777", "DDAF53B04316C7043D6206EF1473A77FD88591288B4A50B6D8FEE0C8D9562CF3", "1A40D9E24E1B9AA60B600444C8BDF87C213572262B589EF79D8EFF8BC7C339A3"},
                {"http://mock.eleven:80/c/", "00:1A:79:b5:bf:27", "5B2ED5ADBA3C0", "24385048CD408E5BAB86789716A77D9C5E8484222CF1D4C188801FF7D577B2B7", "D084C10A69A9125FB250F90A43B6F9987820584983AA21E7CEA0117EFCE7F7E0", "90580DD138DB41269B93D1DE0222FE490E2372A1E296FD9AA838686A483505D0"},
                {"http://mock.eleven:80/c/", "00:1A:79:61:fa:23", "137589A2D155D", "26DB93FCC1B3D3F7CBD3B879EC30AE1006879D0E1CFD170B066225AA2D6BB6A2", "8E1A743B3DE9BB962850819703DE1BF8C1985330C51C204D6ACE600934D26599", "E801B895325F4BF64C56967CF390115C90CECFD2C071C538D432E623A4C3A299"},
                {"http://mock.eleven:80/c/", "00:1A:79:7b:59:14", "8B02A364BA2D3", "E8DF3DA0F440749EF1275095876E9915ACFA02F511C12D98A85CD2C96786006D", "3F1B4F3EDF65693AB8F79CE8FA307500A9C61FBED23D51673382473DC328DEAD", "1B609E2D9F3076527957CAE25323351DDE1B5D580BD5660C0E1E9FCCF2D8579D"},
                {"http://mock.twelve:80/c/", "00:1A:79:c0:b0:22", "5D962DD6332C3", "2F2DC0FB3ADC3C585397D039A9B6C619FC8B94AEBBCC3B93918DF16475279D8D", "4DE68DA3027133CE6C887772699D2F91B662942318E7450D82B04DE86F73D1E8", "AA11C49B4FCA169819BFEB2A65E41DD303CE87097E40F8273CCED5AF91B33B86"},
                {"http://mock.twelve:80/c/", "00:1A:79:d8:a7:79", "D73EB602F3034", "3A74B3E72135D7045AD4F85C4A06BAE9CFF079CE0676D5B076EF8B10D2D40355", "8A9A5231B34345D98F7F816A0AB958B7D16D512D3148A208C7AD036A94D74D57", "9D2F632958D9D09ECD81DCED91ADD6AD5B77B3F864918EE6B48028279568F261"},
                {"http://mock.twelve:80/c/", "00:1A:79:ae:c6:1c", "109414B4BE6CF", "2C798056EB72C72D2739F03323B6B526E2424CAEAA194D942AEB2EBC8C9DF5AA", "5564BCCE95080B6756D135D2F96C9FC6F1EDBDAF1ECE70D3912752EEE7DB0A9C", "344FD6F6DCDAB01DEC11F2D996C9C6C607AC79E47ACD0D2B7FB2F7B518871B40"},
                {"http://mock.twelve:80/c/", "00:1A:79:a7:50:75", "589879544FEE0", "F5FE53187B72A076F5151CC10282E10FED570B008478FD7F7B77062B60474751", "B4E37785B8CA4A67E17AA1BB16122BB5C5424787CCD6EC326B90D61FF8398C8E", "C0E235BD25F61F2C15F7D8AA135C8877AB08DB7B134325462F6C1D49709E155D"},
                {"http://mock.twelve:80/c/", "00:1A:79:b6:44:69", "566796687F504", "ED1586B18385FC897EF297367E8D51DF25EA2A0D8D31F12EFE67C5DE6B7D520D", "F0A015375856AA18761CF1C443E7782040936D3E2C149D265EE6CC6F28EF2CC9", "E3E02C2E6EDE49758D8493DFE165CB7DC097ECAB71B0DD25B0A3C48DC0E61B6B"},
                {"http://mock.thirteen:80/c/", "00:1A:79:88:08:50", "F009FFCB647EA", "E248A01DED42B9ECC53721000885B00912F565CAC085304E8F812605ED379B7E", "9A12505D019EB001A0D68FFE0AF6096D890452066455112CEC836DA73368F7C6", "295D35BD914478D457EF695F831B9619476F23B4D942C0CA68AB3A400B14B7D5"},
                {"http://mock.thirteen:80/c/", "00:1A:79:be:d8:66", "999829ED9F21D", "68B7CE0CB25E27E4F8F8F2A08E41C57D820601936607918BFE0EFC3B15E431EE", "E925043F9C2EBCCEEE12E36E4D4F19E6E946FBB1484C164B0F17E5BB60D26F77", "B95CE96D456AE6C8F24D62525EE98448530B15898F647955792F9534A6FEE333"},
                {"http://mock.thirteen:80/c/", "00:1A:79:d2:ca:58", "B84AFD65D9BD6", "D40D14B0933A22A0D9F3F62EFFB2837F9CABC7E3A528FE8840C22A00D2F67458", "7D7CCA0665EBC909AE8384445FC226A2C1B897D8BD2C17E5884B5024DEF4F6BA", "FD604509DFF6C082087DB030476DC2628416D9C2FEC1736C99432AAC58021075"},
                {"http://mock.thirteen:80/c/", "00:1A:79:5e:0d:cb", "36F3CC86318BF", "90DF7B0A1B49FD1567E523BC90DC4C4B614B2DB6E16413E149F1DD10F8C52F95", "A3C806ABC936B5B2B265A39AD698A620C39EBAA2175EC163CD6BFA6389D232D9", "3BF000B5679771B2BEC32A75EC857BBA7CB43E876752C29ECA2A2E15E7A4C5F4"},
                {"http://mock.thirteen:80/c/", "00:1A:79:48:13:d9", "D06E41969088A", "E4DEC9146A30EB3B7EC0E83D5557D9A1D1CD1A6146840D5716C81E7FD75D8B40", "E273922AC7C82B1E4DBEA5BB3EDC47407986AD40F51754CD12B5846C067E3D95", "E803D44FB2E05430C43603ECDD30CAEB3BAFDDFB81A0A47B325527B432BF5E1B"},
                {"http://mock.thirteen:80/c/", "00:1A:79:c7:7b:23", "16C51AF92BBEC", "C66DD7C493AECC364358A1829908F5494EE581C673DC60F11F7B32C5558193C6", "A2EFC436D00D7D61786A0C877F0871D786884764019CEB83F65C63E7BC321DB3", "15792EFD4D21F2EB5F93F89A753356B93CA4F441CE11FD0DFA3B20A66B384934"},
                {"http://mock.thirteen:80/c/", "00:1A:79:01:30:82", "761CB30734AE8", "F396E0FA19B6864D6CD02487F683D43B0A27C8506AC8416B1F7CD16B71BCB1D5", "EB4D0DF8C94C53867F91A0CC9F6FE417ECAE7853C3A7D370E4520E36E80E0A43", "165C91EA7A18056CB3594D60C0BBE1017957BC7B0E3A3DD8EF4D9A0471C37CF0"},
                {"http://mock.fifteen/c/", "00:1A:79:00:1a:79", "177ECC7EC610E", "950BDE26AAEF819D47EBC3732F1EA3840E80AA5EF19DA054CA398CD3247FE31D", "BAE136F370CD5246892DCC8ED87EBD9EC80B305482304114C7CF9277B7ED8DEE", "E61780CA9A0989CB886944518EB852D8D45300848BC6A720D80F9ECA8CCD982C"},
                {"http://mock.fifteen/c/", "00:1A:79:c7:00:2d", "D1CC891103A60", "DA5E22E56CF50286E1949587ED5A8DD444CCFDCFD45CA10C16BAD9CBA78E5001", "196CF90765B7927253EBF7928C2D4B56E9F059A3B5C95057AD1935D68CF18063", "909437161AFFFE96050074053802C6C93F30EA5DBE0E66E78E86114D31FB95F4"},
                {"http://mock.fifteen/c/", "00:1A:79:32:01:9e", "CC210745F35DF", "EB25108FFC5FE78D54BB0D4DEEB2AC69069DCA11EDDB289455715E569A20B392", "C8C154075B49932CA524943C24BA096F757FBFBF1EA090B39080A8B35D2A3ACB", "629921C56CE5E328CAAB1A4622DAA783C4FDCBD2AFE7A22DA9D8278D56D03FBE"}
        };

        assertEquals(expected.length, savedAccounts.size());

        // Build a lookup map by MAC (normalized to upper case) to avoid relying on insertion order.
        Map<String, Account> byMac = savedAccounts.stream()
                .collect(Collectors.toMap(a -> a.getMacAddress() == null ? "" : a.getMacAddress().toUpperCase(), a -> a, (a, b) -> a));

        for (int i = 0; i < expected.length; i++) {
            String expectedUrl = expected[i][0];
            String expectedMac = expected[i][1];
            String expectedSerial = expected[i][2];
            String expectedDev1 = expected[i][3];
            String expectedDev2 = expected[i][4];
            String expectedSig = expected[i][5];

            String lookupKey = expectedMac == null ? "" : expectedMac.toUpperCase();
            Account actual = byMac.get(lookupKey);
            assertNotNull(actual, "No account found for MAC " + expectedMac + " (expected index " + i + ")");

            assertEquals(expectedUrl, actual.getUrl(), "URL mismatch for MAC " + expectedMac);
            assertEquals(expectedMac, actual.getMacAddress(), "MAC mismatch for MAC " + expectedMac);

            if (expectedSerial == null) {
                assertNull(actual.getSerialNumber(), "Serial expected null for MAC " + expectedMac);
            } else {
                assertEquals(expectedSerial, actual.getSerialNumber(), "Serial mismatch for MAC " + expectedMac);
            }

            if (expectedDev1 == null) {
                assertNull(actual.getDeviceId1(), "Device ID 1 expected null for MAC " + expectedMac);
            } else {
                assertEquals(expectedDev1, actual.getDeviceId1(), "Device ID 1 mismatch for MAC " + expectedMac);
            }

            if (expectedDev2 == null) {
                assertNull(actual.getDeviceId2(), "Device ID 2 expected null for MAC " + expectedMac);
            } else {
                assertEquals(expectedDev2, actual.getDeviceId2(), "Device ID 2 mismatch for MAC " + expectedMac);
            }

            if (expectedSig == null) {
                assertNull(actual.getSignature(), "Signature expected null for MAC " + expectedMac);
            } else {
                assertEquals(expectedSig, actual.getSignature(), "Signature mismatch for MAC " + expectedMac);
            }
        }
    }
}